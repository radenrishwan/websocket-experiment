<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100 h-screen">
    <div class="container mx-auto h-screen p-4">
      <div class="flex h-full bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Left Sidebar -->
        <div class="w-1/3 border-r border-gray-200">
          <!-- Connection Inputs -->
          <div class="p-4 border-b">
            <input
              type="text"
              id="nameInput"
              placeholder="Your name"
              class="w-full p-2 border rounded mb-2"
            />
            <div class="flex gap-2">
              <input
                type="text"
                id="roomInput"
                placeholder="Room name"
                class="flex-1 p-2 border rounded"
              />
              <button
                id="connectBtn"
                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
              >
                Join
              </button>
              <button
                id="disconnectBtn"
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                disabled
              >
                Leave
              </button>
            </div>
            <div id="errorMsg" class="text-red-500 mt-2 hidden"></div>
          </div>

          <!-- Room List -->
          <div class="overflow-y-auto h-[calc(100%-8rem)]">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-600 mb-2">Rooms</h2>
              <ul id="roomList" class="space-y-2"></ul>
            </div>
          </div>
        </div>

        <!-- Right Chat Area -->
        <div class="flex-1 flex flex-col">
          <!-- Chat Header -->
          <div class="bg-gray-100 p-4 flex items-center border-b">
            <div
              class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center"
            >
              <i class="fas fa-users"></i>
            </div>
            <div class="ml-3">
              <h2 id="currentRoomName" class="font-semibold"></h2>
              <p id="typingIndicator" class="text-sm text-gray-500 hidden">
                Someone is typing...
              </p>
            </div>
          </div>

          <!-- Messages Area -->
          <div
            id="messages"
            class="flex-1 overflow-y-auto p-4 bg-[#efeae2] space-y-3"
          ></div>

          <!-- Message Input -->
          <div class="bg-gray-100 p-4 flex items-center space-x-2">
            <input
              type="text"
              id="messageInput"
              class="flex-1 px-4 py-2 rounded-full border focus:outline-none focus:border-green-500"
              placeholder="Type a message"
              disabled
            />
            <button
              id="sendBtn"
              class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let currentRoom = "";
      let typingTimeout = null;

      // DOM Elements
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const nameInput = document.getElementById("nameInput");
      const roomInput = document.getElementById("roomInput");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const messages = document.getElementById("messages");
      const errorMsg = document.getElementById("errorMsg");
      const roomList = document.getElementById("roomList");
      const currentRoomName = document.getElementById("currentRoomName");
      const typingIndicator = document.getElementById("typingIndicator");

      // Fetch room list
      function updateRoomList() {
        fetch("http://localhost:8083/api/rooms")
          .then((response) => response.json())
          .then((data) => {
            roomList.innerHTML = "";
            data.rooms.forEach((room) => {
              const li = document.createElement("li");
              li.className =
                "flex items-center p-3 hover:bg-gray-100 rounded cursor-pointer" +
                (currentRoom === room ? " bg-gray-100" : "");
              li.innerHTML = `
                <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center">
                  <i class="fas fa-users"></i>
                </div>
                <div class="ml-3">
                  <h3 class="font-semibold">${room}</h3>
                  <p class="text-sm text-gray-500">Click to join</p>
                </div>
              `;
              li.onclick = () => {
                if (ws) {
                  disconnect();
                }
                roomInput.value = room;
                connect();
              };
              roomList.appendChild(li);
            });
          });
      }

      function connect() {
        const name = nameInput.value.trim();
        const room = roomInput.value.trim();

        if (!name || !room) {
          showError("Name and room are required");
          return;
        }

        ws = new WebSocket(`ws://localhost:8083/ws?name=${name}&room=${room}`);
        currentRoom = room;

        ws.onopen = () => {
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          messageInput.disabled = false;
          sendBtn.disabled = false;
          hideError();
          currentRoomName.textContent = room;
          addSystemMessage("Connected to room: " + room);
          updateRoomList();
        };

        ws.onclose = () => {
          disconnect();
          addSystemMessage("Disconnected from room");
        };

        ws.onerror = (error) => {
          showError("WebSocket error: " + error.message);
          disconnect();
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          switch (data.type) {
            case 0: // MESSAGE
              addMessage(data.from, data.content);
              break;
            case 3: // TYPING
              if (data.from !== nameInput.value) {
                typingIndicator.textContent = `${data.from} is typing...`;
                typingIndicator.classList.remove("hidden");
              }
              break;
            case 4: // STOP_TYPING
              if (data.from !== nameInput.value) {
                typingIndicator.classList.add("hidden");
              }
              break;
            default:
              addSystemMessage(data.content);
          }
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
        }
        ws = null;
        currentRoom = "";
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        messageInput.disabled = true;
        sendBtn.disabled = true;
        currentRoomName.textContent = "";
        typingIndicator.classList.add("hidden");
        updateRoomList();
      }

      function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !ws) return;

        const message = {
          type: 0, // MESSAGE type
          from: nameInput.value,
          to: currentRoom,
          content: content,
        };

        ws.send(JSON.stringify(message));
        messageInput.value = "";
        sendTypingStop();
      }

      function sendTyping() {
        if (!ws) return;

        const message = {
          type: 3, // TYPING type
          from: nameInput.value,
          to: currentRoom,
          content: "",
        };

        ws.send(JSON.stringify(message));
      }

      function sendTypingStop() {
        if (!ws) return;

        const message = {
          type: 4, // STOP_TYPING type
          from: nameInput.value,
          to: currentRoom,
          content: "",
        };

        ws.send(JSON.stringify(message));
      }

      function addMessage(from, content) {
        const div = document.createElement("div");
        const isCurrentUser = from === nameInput.value;

        div.className = `flex ${isCurrentUser ? "justify-end" : "justify-start"}`;
        div.innerHTML = `
          <div class="max-w-[70%] break-words ${
            isCurrentUser
              ? "bg-green-100 rounded-l-lg rounded-br-lg"
              : "bg-white rounded-r-lg rounded-bl-lg"
          } p-3 shadow">
            ${!isCurrentUser ? `<p class="text-sm font-semibold text-green-600">${from}</p>` : ""}
            <p>${content}</p>
            <p class="text-xs text-gray-500 text-right">${new Date().toLocaleTimeString()}</p>
          </div>
        `;

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function addSystemMessage(content) {
        const div = document.createElement("div");
        div.className = "flex justify-center";
        div.innerHTML = `
          <div class="bg-gray-200 rounded-full px-4 py-1 text-sm text-gray-600">
            ${content}
          </div>
        `;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.classList.remove("hidden");
      }

      function hideError() {
        errorMsg.classList.add("hidden");
      }

      // Event Listeners
      connectBtn.onclick = connect;
      disconnectBtn.onclick = disconnect;
      sendBtn.onclick = sendMessage;

      messageInput.onkeypress = (e) => {
        if (e.key === "Enter") sendMessage();
      };

      messageInput.onkeydown = (e) => {
        if (typingTimeout) {
          clearTimeout(typingTimeout);
        }

        sendTyping();

        typingTimeout = setTimeout(() => {
          sendTypingStop();
        }, 1000);
      };

      // Initial room list fetch
      updateRoomList();
      setInterval(updateRoomList, 5000);
    </script>
  </body>
</html>
