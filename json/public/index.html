<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>

    <title>WebSocket Chat</title>
  </head>
  <body class="bg-gray-100 h-screen">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-gray-800 flex flex-col">
        <!-- User Info -->
        <div class="p-4 bg-gray-900">
          <div class="flex items-center space-x-2">
            <div
              class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center"
            >
              <span class="text-white text-lg" id="userInitial">-</span>
            </div>
            <div class="text-white">
              <div id="userInfoName" class="font-semibold">-</div>
              <div id="userInfoId" class="text-xs text-gray-400">-</div>
            </div>
          </div>
        </div>

        <!-- Chat Type Selector -->
        <div class="p-4 border-b border-gray-700">
          <select
            id="typeSelect"
            class="w-full bg-gray-700 text-white rounded p-2"
          >
            <option value="room">Channels</option>
            <option value="private">Direct Messages</option>
          </select>
        </div>

        <!-- All Users Section -->
        <div class="p-4 border-b border-gray-700">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-gray-400 text-sm font-semibold">ALL USERS</h3>
            <button
              onclick="refreshAllUsers()"
              class="text-gray-400 hover:text-white"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
          </div>
          <div
            id="allUsersList"
            class="space-y-1 max-h-40 overflow-y-auto"
          ></div>
        </div>

        <!-- Rooms/Users List -->
        <div class="flex-1 overflow-y-auto">
          <div class="p-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-gray-400 text-sm font-semibold">
                <span id="listTitle">CHANNELS</span>
              </h3>
              <button id="refreshButton" class="text-gray-400 hover:text-white">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>
            <div id="roomsList" class="space-y-1"></div>
          </div>
        </div>

        <!-- Connected Users -->
        <div id="connectedClients" class="p-4 bg-gray-700">
          <h3 class="text-gray-400 text-sm font-semibold mb-2">
            ONLINE - <span id="clientCount">0</span>
          </h3>
          <ul id="clientsList" class="text-gray-300 text-sm space-y-1"></ul>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="h-16 bg-white border-b flex items-center px-6">
          <div>
            <h2 class="font-semibold" id="currentChatTitle">Welcome</h2>
            <p class="text-sm text-gray-500" id="userInfoConnectAt">-</p>
          </div>
        </div>

        <!-- Messages -->
        <div
          class="flex-1 overflow-y-auto p-6 space-y-4"
          id="messageContainer"
        ></div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t">
          <div class="flex items-center space-x-2">
            <input
              type="text"
              id="nameInput"
              placeholder="Enter your name"
              class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
            />
            <input
              type="text"
              id="roomInput"
              placeholder="Enter room name"
              class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
            />
            <button
              id="connectButton"
              class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
            >
              Connect
            </button>
          </div>
          <div class="flex items-center space-x-2 mt-4">
            <input
              type="text"
              id="messageInput"
              placeholder="Type a message..."
              class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
              onkeydown="handleTyping(event)"
            />
            <button
              id="sendButton"
              class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition"
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws;
      let typingTimeout;
      let clientsRefreshInterval;
      let roomClientsInterval;
      let allUsersRefreshInterval;

      const MESSAGE = 0;
      const JOIN = 1;
      const LEAVE = 2;
      const TYPING = 3;
      const STOP_TYPING = 4;

      document.addEventListener("DOMContentLoaded", () => {
        // Initial setup
        document
          .getElementById("typeSelect")
          .addEventListener("change", handleTypeChange);
        document
          .getElementById("refreshButton")
          .addEventListener("click", refreshRooms);
        document
          .getElementById("connectButton")
          .addEventListener("click", connect);
        document
          .getElementById("sendButton")
          .addEventListener("click", sendMessage);
        document
          .getElementById("messageInput")
          .addEventListener("keydown", handleTyping);

        handleTypeChange();
        refreshRooms();
        refreshAllUsers();
      });

      // All Users Management
      async function refreshAllUsers() {
        try {
          const response = await fetch("http://localhost:8083/api/clients");
          const data = await response.json();
          displayAllUsers(data.clients);
        } catch (error) {
          console.error("Error fetching all users:", error);
        }
      }

      function displayAllUsers(users) {
        const allUsersList = document.getElementById("allUsersList");
        allUsersList.innerHTML = "";

        const currentUserId = document.getElementById("userInfoId").textContent;

        users.forEach((user) => {
          if (user.id === currentUserId) return;

          const userElement = document.createElement("div");
          userElement.className =
            "flex items-center space-x-2 p-2 rounded hover:bg-gray-700 cursor-pointer text-gray-300";

          userElement.innerHTML = `
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            <div class="flex-1">
              <div class="text-sm font-medium">${user.name}</div>
              <div class="text-xs text-gray-400">ID: ${user.id}</div>
            </div>
            <button onclick="startPrivateChat('${user.id}')" class="text-gray-400 hover:text-white text-sm">
              Message
            </button>
          `;

          allUsersList.appendChild(userElement);
        });
      }

      function startPrivateChat(userId) {
        document.getElementById("typeSelect").value = "private";
        document.getElementById("roomInput").value = userId;
        handleTypeChange();
      }

      function startAllUsersRefresh() {
        refreshAllUsers();
        allUsersRefreshInterval = setInterval(refreshAllUsers, 5000);
      }

      function stopAllUsersRefresh() {
        if (allUsersRefreshInterval) {
          clearInterval(allUsersRefreshInterval);
        }
      }

      // Rooms Management
      async function fetchRooms() {
        try {
          const response = await fetch("http://localhost:8083/api/rooms");
          const data = await response.json();
          return data.rooms || [];
        } catch (error) {
          console.error("Error fetching rooms:", error);
          return [];
        }
      }

      async function refreshRooms() {
        const roomsList = document.getElementById("roomsList");
        roomsList.innerHTML = "Loading rooms...";

        const rooms = await fetchRooms();
        displayRooms(rooms);
      }

      function displayRooms(rooms) {
        const roomsList = document.getElementById("roomsList");
        roomsList.innerHTML = "";

        if (rooms.length === 0) {
          roomsList.innerHTML = "No active rooms";
          return;
        }

        rooms.forEach((room) => {
          const roomElement = document.createElement("div");
          roomElement.className =
            "flex items-center space-x-2 p-2 rounded hover:bg-gray-700 cursor-pointer text-gray-300";
          roomElement.innerHTML = `
            <span class="text-gray-400">#</span>
            <span>${room}</span>
          `;
          roomElement.addEventListener("click", () => {
            document.getElementById("roomInput").value = room;
          });
          roomsList.appendChild(roomElement);
        });
      }

      // Clients Management
      async function fetchClients() {
        try {
          const response = await fetch("http://localhost:8083/api/clients");
          const data = await response.json();
          return data.clients || [];
        } catch (error) {
          console.error("Error fetching clients:", error);
          return [];
        }
      }

      async function refreshClients() {
        if (document.getElementById("typeSelect").value === "private") {
          const clients = await fetchClients();
          displayClients(clients);
        }
      }

      function displayClients(clients) {
        const clientsList = document.getElementById("clientsList");
        clientsList.innerHTML = "";
        document.getElementById("clientCount").textContent = clients.length;

        clients.forEach((client) => {
          const li = document.createElement("li");
          li.className = "flex items-center space-x-2";
          li.innerHTML = `
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>${client.name}</span>
          `;
          clientsList.appendChild(li);
        });
      }

      // Type Change Handler
      async function handleTypeChange() {
        const typeSelect = document.getElementById("typeSelect");
        const roomInputContainer =
          document.getElementById("roomInputContainer");
        const roomInput = document.getElementById("roomInput");
        const roomsList = document.getElementById("roomsList");
        const connectedClients = document.getElementById("connectedClients");
        const listTitle = document.getElementById("listTitle");

        if (typeSelect.value === "room") {
          listTitle.textContent = "CHANNELS";
          roomInputContainer.style.display = "block";
          roomInput.placeholder = "Enter room name";
          roomsList.innerHTML = "Loading rooms...";
          connectedClients.style.display = "block";
          const rooms = await fetchRooms();
          displayRooms(rooms);
        } else {
          listTitle.textContent = "DIRECT MESSAGES";
          roomInputContainer.style.display = "block";
          roomInput.placeholder = "Enter user ID";
          roomsList.innerHTML = "Loading users...";
          connectedClients.style.display = "none";
          const clients = await fetchClients();
          displayClients(clients);
        }
      }

      // WebSocket Connection
      function connect() {
        const name = document.getElementById("nameInput").value;
        const type = document.getElementById("typeSelect").value;
        const roomOrPrivate = document.getElementById("roomInput").value;

        if (!name || !roomOrPrivate) {
          alert("Please enter name and room/private ID");
          return;
        }

        let wsUrl = `ws://localhost:8083/ws?name=${encodeURIComponent(name)}`;
        if (type === "room") {
          wsUrl += `&room=${encodeURIComponent(roomOrPrivate)}`;
        } else {
          wsUrl += `&private=${encodeURIComponent(roomOrPrivate)}`;
        }

        if (ws) {
          ws.close();
        }

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          appendMessage("Connected to server", "system");
          startAllUsersRefresh();

          const joinMessage = {
            type: JOIN,
            from: name,
            to: roomOrPrivate,
            content: "",
          };
          ws.send(JSON.stringify(joinMessage));

          if (type === "room") {
            stopClientsRefresh();
            refreshRooms();
            startRoomClientsRefresh(roomOrPrivate);
          } else {
            startClientsRefresh();
            document.getElementById("connectedClients").style.display = "none";
          }
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          handleMessage(message);
        };

        ws.onclose = () => {
          console.log("Disconnected from server");
          appendMessage("Disconnected from server", "system");
          stopClientsRefresh();
          stopRoomClientsRefresh();
          stopAllUsersRefresh();
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          appendMessage("WebSocket error occurred", "system");
        };
      }

      // Message Handling
      function handleMessage(message) {
        console.log("Received message:", message);

        switch (message.type) {
          case MESSAGE:
            if (message.from === "SERVER") {
              try {
                const userData = JSON.parse(message.content);
                updateUserInfo(userData);
              } catch (e) {
                console.error("Error parsing user data:", e);
              }
            } else if (
              message.from !== document.getElementById("nameInput").value
            ) {
              const isPrivate =
                document.getElementById("typeSelect").value === "private";
              const messageClass = isPrivate ? "private-message" : "user";
              const prefix = isPrivate ? "Private message from" : "From";
              appendMessage(
                `${prefix} ${message.from}: ${message.content}`,
                messageClass,
              );
            }
            break;
          case JOIN:
          case LEAVE:
            appendMessage(message.content, "system");
            break;
          case TYPING:
            showTyping(message.from);
            break;
          case STOP_TYPING:
            hideTyping(message.from);
            break;
        }
      }

      function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("Not connected to server");
          return;
        }

        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();
        if (!content) return;

        const message = {
          type: MESSAGE,
          from: document.getElementById("nameInput").value,
          to: document.getElementById("roomInput").value,
          content: content,
        };

        ws.send(JSON.stringify(message));
        appendMessage(`You: ${message.content}`, "user");
        messageInput.value = "";
      }

      function handleTyping(event) {
        if (event.key === "Enter") {
          sendMessage();
          return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        clearTimeout(typingTimeout);
        const message = {
          type: TYPING,
          from: document.getElementById("nameInput").value,
          to: document.getElementById("roomInput").value,
          content: "",
        };
        ws.send(JSON.stringify(message));

        typingTimeout = setTimeout(() => {
          const stopTypingMessage = {
            type: STOP_TYPING,
            from: document.getElementById("nameInput").value,
            to: document.getElementById("roomInput").value,
            content: "",
          };
          ws.send(JSON.stringify(stopTypingMessage));
        }, 1000);
      }

      // UI Updates
      function appendMessage(message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `rounded-lg p-3 max-w-[80%] ${
          type === "user"
            ? "bg-blue-500 text-white ml-auto"
            : type === "system"
              ? "bg-gray-200 text-gray-600 mx-auto text-center text-sm"
              : "bg-gray-100 text-gray-800"
        }`;
        messageDiv.textContent = message;
        const container = document.getElementById("messageContainer");
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      function updateUserInfo(userData) {
        if (userData) {
          document.getElementById("userInfoId").textContent =
            userData.id || "Unknown";
          document.getElementById("userInfoName").textContent =
            userData.name || "Unknown";
          if (userData.connect_at) {
            const connectDate = new Date(userData.connect_at).toLocaleString();
            document.getElementById("userInfoConnectAt").textContent =
              connectDate;
          } else {
            document.getElementById("userInfoConnectAt").textContent =
              "Unknown";
          }
          updateUserInitial();
        }
      }

      function updateUserInitial() {
        const name = document.getElementById("userInfoName").textContent;
        const initial = name !== "Unknown" ? name.charAt(0).toUpperCase() : "?";
        document.getElementById("userInitial").textContent = initial;
      }

      function showTyping(user) {
        const typingDiv =
          document.getElementById(`typing-${user}`) ||
          document.createElement("div");
        typingDiv.id = `typing-${user}`;
        typingDiv.className = "text-sm text-gray-500 italic";
        typingDiv.textContent = `${user} is typing...`;
        document.getElementById("messageContainer").appendChild(typingDiv);
      }

      function hideTyping(user) {
        const typingDiv = document.getElementById(`typing-${user}`);
        if (typingDiv) {
          typingDiv.remove();
        }
      }

      // Room Clients Management
      async function fetchRoomClients(roomName) {
        try {
          const response = await fetch(
            `http://localhost:8083/api/room/clients?name=${encodeURIComponent(roomName)}`,
          );
          const data = await response.json();
          return data.clients || [];
        } catch (error) {
          console.error("Error fetching room clients:", error);
          return [];
        }
      }

      function startRoomClientsRefresh(roomName) {
        refreshRoomClients(roomName);
        roomClientsInterval = setInterval(() => {
          refreshRoomClients(roomName);
        }, 5000);
      }

      function stopRoomClientsRefresh() {
        if (roomClientsInterval) {
          clearInterval(roomClientsInterval);
        }
      }

      async function refreshRoomClients(roomName) {
        const clients = await fetchRoomClients(roomName);
        updateConnectedClients(clients);
      }

      function updateConnectedClients(clients) {
        const clientsList = document.getElementById("clientsList");
        clientsList.innerHTML = "";
        document.getElementById("clientCount").textContent = clients.length;

        clients.forEach((client) => {
          const li = document.createElement("li");
          li.className = "flex items-center space-x-2";
          li.innerHTML = `
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>${client}</span>
          `;
          clientsList.appendChild(li);
        });

        if (clients.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No clients connected";
          clientsList.appendChild(li);
        }
      }

      function startClientsRefresh() {
        if (document.getElementById("typeSelect").value === "private") {
          refreshClients();
          clientsRefreshInterval = setInterval(refreshClients, 5000);
        }
      }

      function stopClientsRefresh() {
        if (clientsRefreshInterval) {
          clearInterval(clientsRefreshInterval);
        }
      }
    </script>
  </body>
</html>
